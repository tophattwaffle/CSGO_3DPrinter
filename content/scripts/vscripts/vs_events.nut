//-----------------------------------------------------------------------
//------------------- Copyright (c) samisalreadytaken -------------------
//                       github.com/samisalreadytaken
//-----------------------------------------------------------------------
local _VERSION = "vs_library v2.43.7",
ROOT=::getroottable(),CONST=::getconsttable();if("VS"in ROOT&&typeof::VS=="table"){if(::VS.version==_VERSION){if(!(0 in::VS))::VS[0]<-0;if(::VS[0]&0x10)return}}else::VS<-{};;local VS={[0]=0x10,version=_VERSION}if(::print.getinfos().native)::Msg<-::print;;if(::EntFireByHandle.getinfos().native)::DoEntFireByInstanceHandle<-::EntFireByHandle;;local AddEvent=::DoEntFireByInstanceHandle,Fmt=::format;VS.GetCaller<-function():(getstackinfos)return getstackinfos(3).locals["this"];VS.MakePersistent<-function(e){return e.__KeyValueFromString("classname","soundent")}VS.GetAllPlayers<-function():(Entities){local e,a=[];while(e=Entities.FindByClassname(e,"player"))a.append(e.weakref());e=null;while(e=Entities.FindByClassname(e,"cs_bot"))a.append(e.weakref());return a}VS.GetPlayerByIndex<-function(i):(Entities){local e;while(e=Entities.FindByClassname(e,"player"))if(e.entindex()==i)return e;e=null;while(e=Entities.FindByClassname(e,"cs_bot"))if(e.entindex()==i)return e}local Events=delegate::VS:{m_hProxy=null,m_bFixedUp=false,m_SV=null,m_Players=null,m_ppCache=null,m_pSpawner=null,m_pListeners=null,s_szEventName=null,s_hListener=null,s_fnSynchronous=null,__rem=null,__tmp=null,m_DeferredReg=null,Msg=Msg}VS.Events<-Events;if(!("{847D4B}"in ROOT))ROOT["{847D4B}"]<-array(64);local gED=ROOT["{847D4B}"];VS.GetPlayerByUserid<-function(i):(Entities){if(m_Players&&i in m_Players)return m_Players[i];if(!m_Players)m_Players={};local p;while(p=Entities.FindByClassname(p,"player")){local s=p.GetScriptScope();if("userid"in s&&s.userid==i){m_Players[i]<-p.weakref();return p}}p=null;while(p=Entities.FindByClassname(p,"cs_bot")){local s=p.GetScriptScope();if("userid"in s&&s.userid==i){m_Players[i]<-p.weakref();return p}}}.bindenv(VS.Events);VS.Events.player_connect<-function(ev):(gED,ROOT,SendToConsole){if(ev.networkid!=""){local x;foreach(i,v in gED)if(!gED[i]){x=i;break};if(x==null){for(local i=32;i<64;++i){gED[i-32]=gED[i];gED[i]=null}x=32;Msg("player_connect: ERROR!!! Player data is not being processed\n")};gED[x]=ev;if(!m_pListeners){local ce=GetCaller();if(!ce.parent||!ce.parent.rawin("{7D6E9A}")){Msg("player_connect: Warning: event listener is not fixed up!\n");m_bFixedUp=false}else m_bFixedUp=true;if("OnGameEvent_player_connect"in ROOT)::OnGameEvent_player_connect(ev)};return true};if(m_SV){local sc=m_SV.remove(0);if(!sc||!("self"in sc))return Msg("VS::ForceValidateUserid: invalid scope in validation\n");if(!sc.__vrefs||!sc.self||!sc.self.IsValid())return Msg("VS::ForceValidateUserid: invalid entity in validation\n");if("userid"in sc&&sc.userid!=ev.userid)Msg("VS::ForceValidateUserid: ERROR!!! conflict! ["+sc.userid+", "+ev.userid+"]\n");sc.userid<-ev.userid;if(!("name"in sc))sc.name<-"";if(!("networkid"in sc))sc.networkid<-"";SendToConsole("banid 0.05 "+ev.userid);if(!(0 in m_SV))m_SV=null}}.bindenv(VS.Events);VS.Events.server_addban<-function(ev){if(!ev.userid)return;if(ev.kicked)return;local p=GetPlayerByUserid(ev.userid);if(!p)return Msg("VS::Events: validation failed to find player! ["+ev.userid+"]\n");local sc=p.GetScriptScope();if(sc.name!=""&&sc.name!=ev.name)Msg(format("VS::Events: validation: [%d] overwriting name '%s' -> '%s'\n",ev.userid,sc.name,ev.name));if(sc.networkid!=""&&sc.networkid!=ev.networkid)Msg(format("VS::Events: validation: [%d] overwriting networkid '%s' -> '%s'\n",ev.userid,sc.networkid,ev.networkid));sc.name=ev.name;sc.networkid=ev.networkid}.bindenv(VS.Events);VS.Events.player_spawn<-function(ev):(gED,Fmt,ROOT){foreach(i,da in gED){if(!da)break;if(da.userid==ev.userid){local p=GetPlayerByIndex(da.index+1);if(!p||!p.ValidateScriptScope()){gED[i]=null;Msg("player_connect: invalid player entity ["+da.userid+"] ["+(da.index+1)+"]\n");break};local sc=p.GetScriptScope();if("networkid"in sc&&sc.networkid!=""){Msg("player_connect: ERROR!!! Something has gone wrong! ");if(sc.networkid==da.networkid){gED[i]=null;Msg(Fmt("Duplicated data. [%d]\n",da.userid))}else Msg(Fmt("Conflicting data. [%d] ('%s', '%s')\n",da.userid,sc.networkid,da.networkid));break};sc.userid<-da.userid;sc.name<-da.name;sc.networkid<-da.networkid;gED[i]=null;gED.sort();gED.reverse();break}}if(!m_pListeners){local ce=GetCaller();if(!ce.parent||!ce.parent.rawin("{7D6E9A}"))Msg("player_spawn: Warning: event listener is not fixed up!\n");if("OnGameEvent_player_spawn"in ROOT)return::OnGameEvent_player_spawn(ev)}}.bindenv(VS.Events);VS.ForceValidateUserid<-function(p,x=0):(AddEvent,Fmt,Entities){if(!x)Msg("Warning: VS::ForceValidateUserid is deprecated!\n");if(!p||!p.IsValid()||(p.GetClassname()!="player")||!p.ValidateScriptScope())return Msg(Fmt("VS::ForceValidateUserid: invalid input: %s\n",""+p));if(!m_SV)m_SV=[];local sc=p.GetScriptScope(),b=1;foreach(v in m_SV)if(v==sc){b=0;break};if(b)m_SV.append(sc.weakref());if(!m_hProxy){local h=Entities.CreateByClassname("info_game_event_proxy");h.__KeyValueFromString("event_name","player_connect");MakePersistent(h);m_hProxy=h.weakref()};return AddEvent(m_hProxy,"GenerateGameEvent","",0,p,null)}.bindenv(VS.Events);VS.ValidateUseridAll<-function(){Msg("Warning: VS::ValidateUseridAll is deprecated!\n");if(Events.m_bFixedUp){foreach(i,v in GetAllPlayers())if(!("userid"in v.GetScriptScope()))ForceValidateUserid(v)}else{Msg("VS::ValidateUseridAll: Warning: player_connect event listener is not fixed up!");local d=::delay,t=::FrameTime();foreach(i,v in GetAllPlayers())d("::VS.ForceValidateUserid(self)",i*t,v)}}VS.Events.ForceValidateUserid<-VS.ForceValidateUserid.weakref();VS.Events.ValidateUseridAll<-VS.ValidateUseridAll.weakref();VS.FixupEventListener<-function(p){if(!p||!p.IsValid()||(p.GetClassname()!="logic_eventlistener")||!p.ValidateScriptScope())return Msg("VS::FixupEventListener: invalid event listener input\n");local sc=p.GetScriptScope();if(sc.parent.rawin("{7D6E9A}"))return Msg("VS::FixupEventListener: already fixed up "+p+"\n");local _c=[];sc.rawdelete("event_data");if(!m_ppCache)m_ppCache=[];m_ppCache.append(_c.weakref());delegate(delegate(delegate sc.parent:{_delslot=function(k){delete parent.parent[k]}}):{_newslot=function(k,v):(_c){if(k=="event_data")_c.insert(0,v);else rawset(k,v)},_get=function(k):(_c){if(k=="event_data")return _c.pop();return rawget(k)},["{7D6E9A}"]=null}):sc}local __RemovePooledString=function(sz){__rem=sz;m_pSpawner.SpawnEntity();__rem=null}.bindenv(VS.Events);VS.Events.SpawnEntity<-function(en):(Entities){if(!m_pSpawner){local h=Entities.CreateByClassname("env_entity_maker");h.__KeyValueFromString("EntityTemplate","vs.eventlistener");MakePersistent(h);m_pSpawner=h.weakref()};s_szEventName=en;m_pSpawner.SpawnEntity();local r=s_hListener;s_szEventName=s_hListener=null;return r}VS.Events.__ExecutePreSpawn<-function(p){local vs=VS.Events;if(vs.__rem){p.__KeyValueFromString("targetname",vs.__rem);p.__KeyValueFromString("EventName","player_connect");p.Destroy();return};local en=vs.s_szEventName;if(!en){p.Destroy();return Msg("VS::Events::PreSpawn: invalid call origin\n")};p.__KeyValueFromString("EventName",en);p.__KeyValueFromInt("FetchEventData",1);p.__KeyValueFromInt("IsEnabled",1);p.__KeyValueFromInt("TeamNum",-1);__EntityMakerResult={}}VS.Events.__FinishSpawn<-function(){__EntityMakerResult=null}VS.Events.PostSpawn<-function(pE){foreach(p in pE){s_hListener=p;FixupEventListener(p);MakePersistent(p);local sc=p.GetScriptScope();if(!s_fnSynchronous){local n=sc.__vname;local i=n.find("_");n=s_szEventName+"_"+n.slice(0,i);p.__KeyValueFromString("targetname",n);p.__KeyValueFromString("OnEventFired",n+",CallScriptFunction,OnEventFired,0,-1");sc.OnEventFired<-null}else{m_ppCache.pop();p.__KeyValueFromString("targetname","");delete sc.parent._get;sc.parent._newslot=function(k,v):(s_fnSynchronous){if(k=="event_data")return s_fnSynchronous(v);return rawset(k,v)}}}}.bindenv(VS.Events);VS.Events.OnPostSpawn<-function():(__RemovePooledString){local VS=VS;if(!VS.Events.m_bFixedUp){VS.Events.m_bFixedUp=true;Msg("VS::Events init\n");VS.StopListeningToAllGameEvents("VS::Events");VS.ListenToGameEvent("player_connect",VS.Events.player_connect,"VS::Events");VS.ListenToGameEvent("player_spawn",VS.Events.player_spawn,"VS::Events");VS.ListenToGameEvent("server_addban",VS.Events.server_addban,"VS::Events");VS.ListenToGameEvent("player_activate",function(ev){foreach(i,v in GetAllPlayers())if(!("userid"in v.GetScriptScope()))ForceValidateUserid(v,1)}.bindenv(VS),"VS::Events");VS.ListenToGameEvent("player_disconnect",function(ev){if(m_Players&&ev.userid in m_Players)delete m_Players[ev.userid]}.bindenv(VS.Events),"VS::Events");if(VS.Events.m_DeferredReg){foreach(p in VS.Events.m_DeferredReg)VS.ListenToGameEvent.pacall(p);VS.Events.m_DeferredReg=null}};if(VS.Events.__tmp)__RemovePooledString(VS.Events.__tmp);VS.Events.__tmp=__vname}VS.ListenToGameEvent<-function(ev,cb,cx){local err;if((typeof cb!="function")&&(typeof cb!="native function"))err="invalid callback param";if(typeof cx!="string")err="invalid context param";if(typeof ev!="string")err="invalid eventname param";if(err){Msg(format("\nAN ERROR HAS OCCURED [%s]\n",err));return PrintStack()};if(!m_pListeners)m_pListeners={};if(!(ev in m_pListeners))m_pListeners[ev]<-{};local pL=m_pListeners[ev];if(!(cx in pL))pL[cx]<-null;if(!m_bFixedUp){if(!m_DeferredReg)m_DeferredReg=[];m_DeferredReg.append([this,ev,cb,cx]);return};local p=pL[cx];if(!p){if(cx=="VS::Events")s_fnSynchronous=cb;else s_fnSynchronous=null;if(!(p=SpawnEntity(ev)))return Msg("VS::ListenToGameEvent: ERROR!!! NULL ent!\n");pL[cx]=p.weakref();if(s_fnSynchronous){s_fnSynchronous=null;return}};local sc=p.GetScriptScope();sc.OnEventFired<-function():(cb){return cb(event_data)}}.bindenv(VS.Events);VS.StopListeningToAllGameEvents<-function(cx):(__RemovePooledString){if(m_pListeners){foreach(ll in m_pListeners){if(cx in ll){local p=ll[cx];if(p&&(typeof p=="instance")&&p.IsValid())p.Destroy();delete ll[cx]}}}}.bindenv(VS.Events);local __ExecutePreSpawn=delete VS.Events.__ExecutePreSpawn,__FinishSpawn=delete VS.Events.__FinishSpawn,PostSpawn=delete VS.Events.PostSpawn,OnPostSpawn=delete VS.Events.OnPostSpawn;VS.Events.InitTemplate<-function(t):(__ExecutePreSpawn,__FinishSpawn,PostSpawn,OnPostSpawn){local p;if(!("self"in t)||!(p=t.self)||!p.IsValid()||p.GetClassname()!="point_template")throw"VS::Events::InitTemplate: invalid entity";p.__KeyValueFromInt("spawnflags",0);p.__KeyValueFromString("targetname","vs.eventlistener");t.__EntityMakerResult<-null;t.__ExecutePreSpawn<-__ExecutePreSpawn;t.__FinishSpawn<-__FinishSpawn;t.PreSpawnInstance<-1;t.PostSpawn<-PostSpawn;t.OnPostSpawn<-OnPostSpawn.bindenv(t);if(m_ppCache){for(local i=m_ppCache.len();i--;){local v=m_ppCache[i];if(v)v.clear();else m_ppCache.remove(i)}};if("EventQueue"in VS)VS.EventQueue.Clear()}{local gVS=::VS;if(!gVS.len()){foreach(k,v in VS)gVS[k]<-v;return::collectgarbage()};if(VS==gVS)return::collectgarbage();if(gVS.version==VS.version){local n=gVS[0]|VS[0];foreach(k,v in VS)gVS[k]<-v;gVS[0]=n;return::collectgarbage()};local vnt="",vst=gVS.version;local c=vst.len();for(local i=0;i<c;++i){local ch=vst[i];if(ch>='0'&&ch<='9')vnt+=ch.tochar()}if(vnt==""){vnt=0;Msg("VS: invalid version number ("+vst+")!\n")};vnt=vnt.tointeger();local vni="",vsi=VS.version;c=vsi.len();for(local i=0;i<c;++i){local ch=vsi[i];if(ch>='0'&&ch<='9')vni+=ch.tochar()}if(vni==""){vni=0;Msg("VS: invalid version number ("+vsi+")\n")};vni=vni.tointeger();if(vnt==vni){Msg("VS: non-matching version strings!\n");return::collectgarbage()};if(vnt<vni){foreach(k,v in VS){if(k=="Events")continue;gVS[k]<-v}}else{foreach(k,v in VS){if(k=="Events")continue;if(!(k in gVS))gVS[k]<-v}};VS=null;return::collectgarbage()}
